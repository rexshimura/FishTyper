<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="icon.png">
    <title>( ‚ú¶ ) FishTyper - Game</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            background-color: #00bfff; 
            transition: background-color 5s linear;
        }

        #game-area {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* --- WATER EFFECTS --- */
        .water-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.3) 0%, rgba(0, 0, 0, 0) 60%),
                repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 2px, transparent 2px, transparent 10px);
            z-index: 1;
            pointer-events: none;
        }

        .caustics {
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: transparent;
            background-image: 
                radial-gradient(rgba(255,255,255,0.1) 20%, transparent 20%),
                radial-gradient(rgba(255,255,255,0.1) 20%, transparent 20%);
            background-position: 0 0, 50px 50px;
            background-size: 100px 100px;
            animation: ripple 8s linear infinite;
            z-index: 1;
            opacity: 0.3;
            pointer-events: none;
        }

        @keyframes ripple {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(-50px) rotate(5deg); }
        }

        /* --- ZONE DISPLAY --- */
        #zone-display {
            position: absolute;
            top: 10%; 
            left: 50%; 
            transform: translateX(-50%); 
            padding: 10px 40px;
            background: transparent; 
            border-bottom: 2px solid rgba(255, 255, 255, 0.3); 
            z-index: 15;
            pointer-events: none;
            opacity: 0; 
            text-align: center;
            transition: opacity 0.5s;
        }

        .zone-anim { animation: slideFade 4s ease-in-out forwards; }

        @keyframes slideFade {
            0% { transform: translate(-50%, -20px); opacity: 0; }
            15% { transform: translate(-50%, 0); opacity: 1; }
            85% { transform: translate(-50%, 0); opacity: 1; }
            100% { transform: translate(-50%, -10px); opacity: 0; }
        }

        .zone-title {
            font-size: 3.5rem; 
            font-weight: 900;
            letter-spacing: 5px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 0 10px rgba(0, 191, 255, 0.8), 2px 2px 4px rgba(0, 0, 0, 0.8);
            display: block;
            white-space: nowrap;
        }

        .zone-sub {
            font-size: 0.9rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 3px;
            text-transform: uppercase;
            display: block;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px black;
        }

        .gold-zone { border-bottom-color: rgba(255, 215, 0, 0.5) !important; }
        .gold-zone .zone-title {
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        /* --- HUD (SEAMLESS LEFT ALIGN) --- */
        #hud-container {
            position: absolute;
            top: 30px; 
            left: 0px; /* Snapped to left edge */
            
            /* Seamless Gradient Background */
            background: linear-gradient(90deg, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0) 100%);
            
            padding: 15px 20px 15px 30px; /* Left padding pushes text off the wall */
            
            /* Clean Left Anchor Bar */
            border-left: 5px solid white;
            
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Aligns children to the left */
            gap: 8px;
            min-width: 200px;
            pointer-events: none;
            font-family: 'Courier New', monospace;
        }

        /* Top: Depth */
        .hud-depth-box {
            text-align: left; /* Text aligns left */
            width: 100%;
        }
        
        .hud-label-sm {
            font-size: 0.75rem;
            color: #88ccee;
            letter-spacing: 2px;
            margin-bottom: 2px;
            text-transform: uppercase;
            font-weight: bold;
            text-shadow: 1px 1px 2px black; /* Shadow for readability without box */
        }

        #depth {
            font-size: 3.5rem; /* Slightly larger for emphasis */
            font-weight: 900;
            color: #ffffff;
            text-shadow: 0 0 15px rgba(0, 191, 255, 0.8);
            line-height: 0.9;
            transition: color 0.3s;
        }

        /* Middle: Kills | Score */
        .hud-stats-row {
            display: flex;
            justify-content: flex-start; /* Align row to left */
            align-items: center;
            width: 100%;
            gap: 20px; /* Space between Kills and Score */
        }

        .stat-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align labels/numbers left */
        }

        .stat-divider {
            color: rgba(255,255,255,0.3);
            font-size: 1.5rem;
            font-weight: 100;
            margin-top: 10px;
        }

        #kills { 
            color: #ff4757; 
            font-size: 1.6rem; 
            font-weight: bold; 
            text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }
        #score { 
            color: #ffd700; 
            font-size: 1.6rem; 
            font-weight: bold;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }

        /* Bottom: HP Images */
        #hearts-container {
            display: flex;
            gap: 8px;
            margin-top: 5px;
            /* Removed background for seamless look */
        }

        .heart-img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8)); /* Strong shadow */
            transition: transform 0.2s;
        }

        /* --- ANIMATIONS --- */
        .pop-anim {
            animation: textPop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes textPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); color: white; }
            100% { transform: scale(1); }
        }

        .depth-pulse {
            animation: depthPulse 0.5s ease-out;
        }

        @keyframes depthPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); text-shadow: 0 0 25px rgba(0, 191, 255, 1); }
            100% { transform: scale(1); }
        }

        /* --- SCANNER --- */
        #scanner-container {
            position: absolute; bottom: 20px; right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00bfff;
            border-radius: 8px;
            padding: 15px;
            color: #00bfff;
            width: 220px;
            z-index: 20;
            backdrop-filter: blur(4px);
            pointer-events: none;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.2);
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 1; transform: translateY(0);
        }

        .hud-hidden { opacity: 0 !important; transform: translateY(20px) !important; pointer-events: none; }
        .scanner-header {
            border-bottom: 2px solid #00bfff;
            margin-bottom: 10px; padding-bottom: 5px;
            font-weight: bold; text-align: center;
            font-size: 1rem; letter-spacing: 2px;
            text-shadow: 0 0 5px #00bfff;
        }

        #scanner-list { display: flex; flex-direction: column; gap: 5px; max-height: 300px; overflow: hidden; }
        .scanner-item {
            display: flex; align-items: center; gap: 10px;
            font-size: 0.9rem; color: white;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 8px; border-radius: 4px;
        }
        .scanner-icon { width: 24px; height: 24px; object-fit: contain; }

        /* --- TOP RIGHT CONTROLS --- */
        #top-controls {
            position: absolute; 
            top: 20px; 
            right: 20px; 
            z-index: 30;
            display: flex;
            gap: 15px;
        }

        .circle-ui-btn {
            position: relative;
            width: 60px; 
            height: 60px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid white; 
            color: white;
            border-radius: 50%; 
            cursor: pointer;
            display: flex; 
            justify-content: center; 
            align-items: center;
            transition: transform 0.2s, background 0.2s;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .circle-ui-btn:hover { 
            background: rgba(255, 255, 255, 0.2); 
            transform: scale(1.1); 
        }

        .ui-icon-img {
            width: 30px;
            height: 30px;
            object-fit: contain;
            pointer-events: none;
        }

        .shortcut-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background-color: #ffd700;
            color: #000;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.75rem;
            font-weight: 900;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            pointer-events: none; 
            z-index: 35;
        }
        
        .badge-wide {
            width: 32px;
            border-radius: 12px;
            font-size: 0.65rem;
        }

        /* --- DEV MODE --- */
        #dev-container { position: absolute; bottom: 20px; left: 20px; z-index: 100; font-family: monospace; }
        #dev-toggle-btn {
            background: #333; color: #fff; border: 2px solid #555;
            padding: 8px 15px; cursor: pointer; font-weight: bold;
            border-radius: 5px; transition: background 0.2s;
        }
        #dev-toggle-btn:hover { background: #444; }
        #dev-menu {
            display: none; position: absolute; bottom: 45px; left: 0;
            background: rgba(0, 0, 0, 0.9); border: 2px solid #00ff00;
            padding: 15px; border-radius: 8px; color: #00ff00;
            width: 250px; box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }
        .dev-header { border-bottom: 1px solid #00ff00; margin-bottom: 10px; padding-bottom: 5px; font-weight: bold; text-align: center; }
        .dev-spawner-grid { display: flex; flex-wrap: wrap; gap: 5px; max-height: 300px; overflow-y: auto; }
        .dev-spawn-btn {
            background: #111; color: #00ff00; border: 1px solid #00ff00;
            padding: 5px; font-size: 0.8rem; cursor: pointer;
            flex: 1 1 40%; text-transform: capitalize;
        }
        .dev-spawn-btn:hover { background: #00ff00; color: black; }
        .dev-active-indicator { color: yellow; font-size: 0.8rem; margin-bottom: 10px; }

        /* --- TYPING AREA --- */
        #typing-area {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); 
            background: rgba(0, 0, 0, 0.8); border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 15px; padding: 15px 50px;
            color: white; font-size: 2.2rem; min-width: 250px;
            text-align: center; z-index: 20; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .floating-char {
            position: absolute; color: #ffd700; font-weight: bold; font-size: 2rem;
            pointer-events: none; animation: floatChar 0.8s ease-out forwards;
            text-shadow: 0 0 10px gold; z-index: 21;
        }
        @keyframes floatChar {
            0% { transform: translate(-50%, 0) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -40px) scale(1.5); opacity: 0.8; }
            100% { transform: translate(-50%, -80px) scale(1); opacity: 0; }
        }
        .success-anim { border-color: #7aff7a !important; box-shadow: 0 0 30px #7aff7a !important; }
        .placeholder-text { color: #666; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; }

        /* Fish Entities */
        .fish {
            position: absolute; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; z-index: 5;
        }
        .effect-gold img {
            filter: drop-shadow(0 0 10px gold) brightness(1.2);
            animation: shine 1.5s infinite alternate ease-in-out;
        }
        @keyframes shine {
            from { filter: drop-shadow(0 0 5px #ffd700) brightness(1.1); }
            to { filter: drop-shadow(0 0 25px #ffea00) brightness(1.5); }
        }
        .score-popup {
            position: absolute; color: #ffff00; font-weight: 900; font-size: 2.5rem;
            text-shadow: 3px 3px 0px #000; pointer-events: none; 
            animation: floatUp 0.8s ease-out forwards; z-index: 30; 
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-60px) scale(1.2); opacity: 0; }
        }
        .particle {
            position: absolute; width: 8px; height: 8px; border-radius: 50%;
            pointer-events: none; z-index: 25; animation: explode 0.6s ease-out forwards;
        }
        @keyframes explode {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0; }
        }
        .fish img { height: auto; image-rendering: pixelated; transition: width 0.2s; }
        .word-box {
            background: rgba(0, 0, 0, 0.6); color: white; padding: 4px 10px;
            border-radius: 4px; font-size: 1.5rem; font-weight: bold;
            margin-bottom: 5px; white-space: nowrap; text-shadow: 1px 1px 2px black;
        }
        .highlight { color: #ffd700; text-shadow: 0 0 10px orange, 0 0 2px white; font-weight: 900; }

        /* --- MENUS --- */
        #game-over, #pause-overlay {
            display: none; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85);
            color: white; flex-direction: column; justify-content: center;
            align-items: center; z-index: 50; backdrop-filter: blur(5px);
        }
        
        #pause-overlay { background: rgba(0, 0, 0, 0.6); z-index: 40; }

        .menu-btn {
            padding: 10px 30px; font-size: 1.5rem; cursor: pointer;
            margin-top: 20px; pointer-events: auto; background: #fff;
            border: none; border-radius: 50px; font-weight: bold;
            color: #333; transition: transform 0.1s;
        }
        .menu-btn:hover { transform: scale(1.05); background: #f0f0f0; }

        /* NEW BUTTON STYLES FOR PAUSE */
        .btn-row {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            align-items: center;
        }

        .circle-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid white;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            pointer-events: auto;
            position: relative;
        }

        .circle-btn:hover {
            transform: scale(1.1);
            background-color: #555;
        }

        /* Color variations */
        .btn-home { background-color: #ff6b6b; }
        .btn-home:hover { background-color: #ff4757; }
        
        .btn-reset { background-color: #f1c40f; }
        .btn-reset:hover { background-color: #f39c12; }

        .icon-img {
            width: 35px;
            height: 35px;
            object-fit: contain;
            pointer-events: none;
        }
        
        /* General Confirmation Section (Used for Reset & Home) */
        #confirmation-menu {
            display: none;
            flex-direction: column;
            align-items: center;
            animation: fadeIn 0.2s;
        }
        
        #pause-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

    </style>
</head>
<body>

    <div id="game-area">
        <div class="water-overlay"></div>
        <div class="caustics"></div>

        <div id="zone-display">
            <span class="zone-sub">CURRENT REGION</span>
            <span id="zone-name" class="zone-title">SUNLIGHT ZONE</span>
        </div>

        <div id="hud-container">
            <div class="hud-depth-box">
                <div class="hud-label-sm"></div>
                <div id="depth">0m</div>
            </div>

            <div class="hud-stats-row">
                <div class="stat-group">
                    <div class="hud-label-sm">KILLS</div>
                    <div id="kills">0</div>
                </div>
                
                <div class="stat-divider">|</div>
                
                <div class="stat-group">
                    <div class="hud-label-sm">SCORE</div>
                    <div id="score">0</div>
                </div>
            </div>

            <div id="hearts-container">
                </div>
        </div>

        <div id="scanner-container">
            <div class="scanner-header">SONAR: DETECTED</div>
            <div id="scanner-list">
            </div>
        </div>

        <div id="top-controls">
            <button class="circle-ui-btn" onclick="toggleSonar()" title="Toggle Sonar">
                <img src="public/icons/sonar.png" class="ui-icon-img" alt="Sonar">
                <div class="shortcut-badge">1</div>
            </button>

            <button id="pause-btn" class="circle-ui-btn" title="Pause Game">
                <img id="pause-icon-img" src="public/icons/pause.png" class="ui-icon-img" alt="Pause">
                <div class="shortcut-badge badge-wide">TAB</div>
            </button>
        </div>

        <!-- <div id="dev-container">
            <button id="dev-toggle-btn" onclick="toggleDevMode()">üõ†Ô∏è Dev Mode</button>
            <div id="dev-menu">
                <div class="dev-header">DEVELOPER MENU</div>
                <div class="dev-active-indicator">Invincibility: <b>ON</b></div>
                <div class="dev-spawner-grid" id="spawner-list">
                </div>
            </div>
        </div> -->
        
        <div id="typing-area">
            <span id="target-display"><span class="placeholder-text">WAITING FOR TARGET...</span></span>
        </div>
        
        <div id="pause-overlay">
            
            <div id="pause-controls">
                <h1 style="font-size: 4rem; margin: 0;">PAUSED</h1>
                <p style="margin-top: 10px; opacity: 0.7;">Press TAB to Resume</p>
                
                <button class="menu-btn" onclick="togglePause()">RESUME</button>
                
                <div class="btn-row">
                    <button class="circle-btn btn-reset" onclick="triggerAction('reset')" title="Reset Game">
                        <img src="public/icons/refresh-arrow.png" alt="R" class="icon-img">
                    </button>
                    
                    <button class="circle-btn btn-home" onclick="triggerAction('home')" title="Main Menu">
                        <img src="public/icons/home.png" alt="H" class="icon-img">
                    </button>
                </div>
            </div>

            <div id="confirmation-menu">
                <h2 id="confirmation-title" style="color: #f1c40f; text-transform: uppercase;">Are you sure?</h2>
                <p>All progress will be lost.</p>
                <div class="btn-row">
                    <button class="menu-btn" style="background:#ff4757; color:white;" onclick="confirmAction()">YES</button>
                    <button class="menu-btn" onclick="cancelAction()">NO</button>
                </div>
            </div>

        </div>
    </div>

    <div id="game-over">
        <h1 style="color: #ff4757; font-size: 4rem;">GAME OVER</h1>
        <h2>Final Score: <span id="final-score">0</span></h2>
        <h2>Total Kills: <span id="final-kills">0</span></h2>
        <h2>Max Depth: <span id="final-depth">0</span>m</h2>
        <button class="menu-btn" onclick="location.reload()">Try Again</button>
        <button class="menu-btn" onclick="window.location.href='index.html'">Main Menu</button>
    </div>

    <script src="words.js"></script>
    <script src="configuration.js"></script>

    <script>
        const gameArea = document.getElementById('game-area');
        const scoreEl = document.getElementById('score');
        const killsEl = document.getElementById('kills');
        const heartsContainer = document.getElementById('hearts-container');
        const depthEl = document.getElementById('depth');
        const scannerContainer = document.getElementById('scanner-container'); 
        const scannerListEl = document.getElementById('scanner-list');
        const typingArea = document.getElementById('typing-area');
        const targetDisplay = document.getElementById('target-display');
        const gameOverScreen = document.getElementById('game-over');
        
        // Pause Button & Icons
        const pauseBtn = document.getElementById('pause-btn');
        const pauseIconImg = document.getElementById('pause-icon-img'); // New ref
        const pauseOverlay = document.getElementById('pause-overlay');
        
        // Pause Sub-menus
        const pauseControls = document.getElementById('pause-controls');
        const confirmationMenu = document.getElementById('confirmation-menu');
        const confirmationTitle = document.getElementById('confirmation-title');
        
        // DEV MODE ELEMENTS
        const devMenu = document.getElementById('dev-menu');
        const devToggleBtn = document.getElementById('dev-toggle-btn');
        const spawnerList = document.getElementById('spawner-list');
        
        let score = 0;
        let killCount = 0;
        let hearts = 5;
        let maxHearts = 5;
        let depth = 0;
        let gameActive = true;
        let activeFishes = [];
        let targetFish = null;
        
        let spawnRate = gameSettings.initialSpawnRate; 
        let lastSpawn = 0;
        let depthTimer = 0;

        let isPaused = false;
        let pauseStartTime = 0;
        let isDevMode = false;
        let currentScannerSignature = "";
        
        let currentZoneName = "";
        
        // Track what action is being confirmed
        let pendingAction = null; // 'reset' or 'home'

        // Animation helper
        function triggerAnim(element, animClass) {
            element.classList.remove(animClass);
            void element.offsetWidth; // Trigger reflow
            element.classList.add(animClass);
            setTimeout(() => {
                element.classList.remove(animClass);
            }, 500);
        }

        function loop(timestamp) {
            if (!gameActive) return;
            if (isPaused) {
                requestAnimationFrame(loop);
                return;
            }

            if (timestamp - depthTimer > 1000) {
                depth += (typeof gameSettings !== 'undefined' ? gameSettings.depthIncreaseRate : 5); 
                depthEl.innerText = depth + "m";
                triggerAnim(depthEl, 'depth-pulse'); // Animate depth

                depthTimer = timestamp;
                
                updateEnvironment();
                updateScanner(); 
                updateZoneDisplay(); 
            }

            if (timestamp - lastSpawn > spawnRate) {
                spawnFish();
                lastSpawn = timestamp;
                const minRate = typeof gameSettings !== 'undefined' ? gameSettings.minSpawnRate : 800;
                if (spawnRate > minRate) spawnRate -= 10;
            }

            activeFishes.forEach((fish, index) => {
                if (fish.isDead) return;

                fish.x -= fish.speed;
                fish.element.style.left = fish.x + 'px';

                if (fish.x < -200) {
                    takeDamage(index);
                }
            });

            requestAnimationFrame(loop);
        }

        pauseBtn.addEventListener('click', () => { togglePause(); pauseBtn.blur(); });

        // HELPER TO TOGGLE SONAR
        function toggleSonar() {
            scannerContainer.classList.toggle('hud-hidden');
            if(document.activeElement) document.activeElement.blur();
        }

        window.addEventListener('keydown', (e) => {
            // PAUSE
            if (e.key === "Escape" || e.key === "Tab") {
                e.preventDefault();
                togglePause();
            }

            // SCANNER TOGGLE (1)
            if (e.key === "1") {
                toggleSonar();
            }
        });

        // --- ZONE DISPLAY ---
        function updateZoneDisplay() {
            let newZone = "";
            let isGold = false;

            if (depth < 350) { newZone = "SUNLIGHT ZONE"; }
            else if (depth < 500) { newZone = "GOLD RUSH"; isGold = true; }
            else if (depth < 1000) { newZone = "TWILIGHT ZONE"; }
            else if (depth < 1300) { newZone = "GOLD RUSH"; isGold = true; }
            else if (depth < 2400) { newZone = "MIDNIGHT ZONE"; }
            else if (depth < 2800) { newZone = "GOLD RUSH"; isGold = true; }
            else if (depth < 4800) { newZone = "THE ABYSS"; }
            else { newZone = "THE TRENCH"; }

            if (newZone !== currentZoneName) {
                currentZoneName = newZone;
                const zoneDisplay = document.getElementById('zone-display');
                const zoneNameText = document.getElementById('zone-name');
                zoneNameText.innerText = newZone;

                if (isGold) zoneDisplay.classList.add('gold-zone');
                else zoneDisplay.classList.remove('gold-zone');

                zoneDisplay.classList.remove('zone-anim');
                void zoneDisplay.offsetWidth; 
                zoneDisplay.classList.add('zone-anim');
            }
        }

        // --- SCANNER ---
        function updateScanner() {
            if (typeof fishConfig === 'undefined') return;
            const availableFish = fishConfig.filter(f => {
                const isDeepEnough = depth >= f.minDepth;
                const isNotTooDeep = f.maxDepth === null || depth <= f.maxDepth;
                const hasWeight = (f.spawnWeight !== undefined && f.spawnWeight > 0) || f.spawnWeight === undefined; 
                return isDeepEnough && isNotTooDeep && hasWeight;
            });

            const signature = availableFish.map(f => f.type).join(',');

            if (signature !== currentScannerSignature) {
                currentScannerSignature = signature;
                scannerListEl.innerHTML = '';
                if (availableFish.length === 0) {
                    scannerListEl.innerHTML = '<div class="scanner-item" style="color:red">NO SIGNAL</div>';
                    return;
                }
                availableFish.forEach(fish => {
                    const item = document.createElement('div');
                    item.className = 'scanner-item';
                    item.innerHTML = `
                        <img src="${fish.imgSrc}" class="scanner-icon">
                        <span style="text-transform: capitalize;">${fish.type}</span>
                    `;
                    scannerListEl.appendChild(item);
                });
            }
        }

        // --- DEV MODE ---
        function toggleDevMode() {
            isDevMode = !isDevMode;
            if (isDevMode) {
                devMenu.style.display = 'block';
                devToggleBtn.style.backgroundColor = '#00ff00';
                devToggleBtn.style.color = 'black';
                populateDevSpawners();
            } else {
                devMenu.style.display = 'none';
                devToggleBtn.style.backgroundColor = '#333';
                devToggleBtn.style.color = 'white';
            }
            devToggleBtn.blur();
        }

        function populateDevSpawners() {
            spawnerList.innerHTML = '';
            if (typeof fishConfig !== 'undefined') {
                fishConfig.forEach(fish => {
                    const btn = document.createElement('button');
                    btn.className = 'dev-spawn-btn';
                    btn.innerText = fish.type;
                    btn.title = `Spawn ${fish.type}`;
                    btn.onclick = () => {
                        const randY = Math.random() * (window.innerHeight - 200) + 100;
                        spawnSpecificFish(fish.type, window.innerWidth, randY);
                        window.focus();
                    };
                    spawnerList.appendChild(btn);
                });
            } else {
                spawnerList.innerHTML = '<div style="color:red">Config not loaded</div>';
            }
        }

        // --- PAUSE & RESET LOGIC ---
        function togglePause() {
            if(!gameActive) return;

            isPaused = !isPaused;

            if (isPaused) {
                // Change Icon to PLAY
                pauseIconImg.src = "public/icons/play.png"; 
                pauseOverlay.style.display = "flex";
                
                // Show controls, hide confirmation
                pauseControls.style.display = "flex";
                confirmationMenu.style.display = "none";
                pendingAction = null;
                
                pauseStartTime = performance.now();
            } else {
                // Change Icon back to PAUSE
                pauseIconImg.src = "public/icons/pause.png"; 
                pauseOverlay.style.display = "none";
                const pauseDuration = performance.now() - pauseStartTime;
                lastSpawn += pauseDuration;
                depthTimer += pauseDuration;
            }
        }

        function triggerAction(action) {
            pendingAction = action; // 'reset' or 'home'
            
            // DYNAMIC TEXT CHANGE HERE
            if (action === 'reset') {
                confirmationTitle.innerText = "RESET GAME?";
            } else if (action === 'home') {
                confirmationTitle.innerText = "EXIT TO MENU?";
            }
            
            pauseControls.style.display = "none";
            confirmationMenu.style.display = "flex";
        }

        function cancelAction() {
            pendingAction = null;
            pauseControls.style.display = "flex";
            confirmationMenu.style.display = "none";
        }

        function confirmAction() {
            if (pendingAction === 'reset') {
                location.reload();
            } else if (pendingAction === 'home') {
                window.location.href = 'index.html';
            }
        }

        function updateEnvironment() {
            if (depth < 350) document.body.style.backgroundColor = "#00bfff";
            else if (depth < 500) document.body.style.backgroundColor = "#c4c366";  
            else if (depth < 1000) document.body.style.backgroundColor = "#0077be"; 
            else if (depth < 1300) document.body.style.backgroundColor = "#6b681d"; 
            else if (depth < 2400) document.body.style.backgroundColor = "#003366";
            else if (depth < 2800) document.body.style.backgroundColor = "#383101";  
            else if (depth < 4800) document.body.style.backgroundColor = "#011d38";
            else if (depth < 10000) document.body.style.backgroundColor = "#000c17";  
            else document.body.style.backgroundColor = "#000022";
        }

        function createFishEntity(fishType, x, y) {
            const targetLen = Math.floor(Math.random() * (fishType.lenMax - fishType.lenMin + 1)) + fishType.lenMin;
            const list = wordList[targetLen] || wordList[1];
            let contentText = list[Math.floor(Math.random() * list.length)];
            if(!contentText) contentText = "bug";

            const div = document.createElement('div');
            const effectClass = fishType.effect ? `effect-${fishType.effect}` : '';
            div.className = `fish ${effectClass}`;

            div.style.left = x + 'px'; 
            div.style.top = y + 'px';
            
            const imgWidth = 100 * fishType.scale;

            div.innerHTML = `
                <div class="word-box">${contentText}</div>
                <img src="${fishType.imgSrc}" alt="fish" draggable="false" style="width: ${imgWidth}px;">
            `;

            gameArea.appendChild(div);

            activeFishes.push({
                type: fishType.type,
                word: contentText,
                typed: "",
                element: div,
                x: x,
                y: y,
                speed: fishType.speed,
                scale: fishType.scale, 
                scoreBonus: fishType.scoreBonus || 0,
                isDead: false
            });
        }

        function spawnSpecificFish(typeName, x, y) {
            const fishConfigObj = fishConfig.find(f => f.type === typeName);
            if(fishConfigObj) {
                createFishEntity(fishConfigObj, x, y);
            }
        }

        function spawnFish() {
            const allowedFish = fishConfig.filter(f => {
                const isDeepEnough = depth >= f.minDepth;
                const isNotTooDeep = f.maxDepth === null || depth <= f.maxDepth;
                return isDeepEnough && isNotTooDeep;
            });

            if (allowedFish.length === 0) return; 

            const totalWeight = allowedFish.reduce((sum, f) => sum + (f.spawnWeight || 1), 0);
            let randomValue = Math.random() * totalWeight;
            
            let fishType = allowedFish[0];
            for (let f of allowedFish) {
                randomValue -= (f.spawnWeight || 1);
                if (randomValue <= 0) {
                    fishType = f;
                    break;
                }
            }

            let yPos;
            let attempts = 0;
            const maxAttempts = 15;
            const minVerticalSpacing = 80;
            let collision = false;

            do {
                yPos = Math.random() * (window.innerHeight - 250) + 50;
                collision = false;
                for (let fish of activeFishes) {
                    if (Math.abs(fish.y - yPos) < minVerticalSpacing) {
                        collision = true;
                        break;
                    }
                }
                attempts++;
            } while (collision && attempts < maxAttempts);

            if (collision) return;

            createFishEntity(fishType, window.innerWidth, yPos);
        }

        function takeDamage(index) {
            const fish = activeFishes[index];
            
            if(fish === targetFish) {
                targetFish = null;
                targetDisplay.innerHTML = '<span class="placeholder-text">Target Lost...</span>';
            }

            fish.element.remove();
            activeFishes.splice(index, 1);

            if (isDevMode) {
                const blockMsg = document.createElement('div');
                blockMsg.innerText = "BLOCKED";
                blockMsg.style.position = "absolute";
                blockMsg.style.left = "20px";
                blockMsg.style.bottom = "100px";
                blockMsg.style.color = "#00ff00";
                blockMsg.style.fontWeight = "bold";
                blockMsg.style.fontSize = "1.5rem";
                blockMsg.style.textShadow = "0 0 5px black";
                blockMsg.style.animation = "floatUp 0.5s ease-out forwards";
                gameArea.appendChild(blockMsg);
                setTimeout(() => blockMsg.remove(), 500);
                return;
            }

            hearts--;
            updateHeartsUI();

            if (hearts <= 0) {
                endGame();
            }
        }

        // UPDATED HEARTS UI to use PNGs
        function updateHeartsUI() {
            let html = '';
            for(let i=0; i<maxHearts; i++) {
                if (i < hearts) {
                    html += `<img src="public/icons/heart.png" class="heart-img" alt="HP">`;
                } else {
                    html += `<img src="public/icons/empty_heart.png" class="heart-img" alt="-">`;
                }
            }
            heartsContainer.innerHTML = html;
        }

        function endGame() {
            gameActive = false;
            document.getElementById('final-score').innerText = score;
            document.getElementById('final-depth').innerText = depth;
            document.getElementById('final-kills').innerText = killCount;
            gameOverScreen.style.display = "flex";
            pauseBtn.style.display = "none";
        }

        window.addEventListener('keydown', (e) => {
            if (!gameActive) return;
            if (isPaused) return; 

            if (e.key.length !== 1) return;
            const key = e.key;

            if (!targetFish) {
                const candidate = activeFishes
                    .filter(f => f.word.startsWith(key) && !f.isDead)
                    .sort((a, b) => a.x - b.x)[0];

                if (candidate) {
                    targetFish = candidate;
                    processInput(key);
                }
            } else {
                const nextLetter = targetFish.word[targetFish.typed.length];
                if (key === nextLetter) {
                    processInput(key);
                }
            }
        });

        function processInput(key) {
            targetFish.typed += key;
            const remaining = targetFish.word.substring(targetFish.typed.length);
            
            targetFish.element.querySelector('.word-box').innerHTML = 
                `<span class="highlight">${targetFish.typed}</span>${remaining}`;

            targetDisplay.innerHTML = `<span class="highlight">${targetFish.typed}</span>${remaining}`;

            spawnFloatingChar(key);

            if (targetFish.typed === targetFish.word) {
                killFish(targetFish);
                targetFish = null;
                triggerSuccessAnim();
                targetDisplay.innerHTML = '<span class="placeholder-text">WAITING...</span>';
            }
        }

        function spawnFloatingChar(char) {
            const span = document.createElement('span');
            span.innerText = char.toUpperCase();
            span.className = 'floating-char';
            const offset = (Math.random() * 40) - 20; 
            span.style.left = `calc(50% + ${offset}px)`;
            span.style.bottom = "100%"; 
            typingArea.appendChild(span);
            setTimeout(() => { span.remove(); }, 800);
        }

        function triggerSuccessAnim() {
            typingArea.classList.remove('success-anim');
            void typingArea.offsetWidth; 
            typingArea.classList.add('success-anim');
            setTimeout(() => {
                typingArea.classList.remove('success-anim');
            }, 300);
        }

        function createExplosion(x, y, color) {
            const particleCount = 12;
            for (let i = 0; i < particleCount; i++) {
                const p = document.createElement('div');
                p.classList.add('particle');
                p.style.left = x + 'px';
                p.style.top = y + 'px';
                p.style.background = Math.random() > 0.5 ? color : '#fff';
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 80 + 40;
                
                const dx = Math.cos(angle) * velocity + 'px';
                const dy = Math.sin(angle) * velocity + 'px';

                p.style.setProperty('--dx', dx);
                p.style.setProperty('--dy', dy);

                gameArea.appendChild(p);
                setTimeout(() => { p.remove(); }, 600);
            }
        }

        function killFish(fish) {
            const points = (fish.word.length * gameSettings.pointsPerChar) + fish.scoreBonus;
            
            // Score animation
            score += points;
            scoreEl.innerText = score;
            triggerAnim(scoreEl, 'pop-anim');
            
            // Kills animation
            killCount++;
            killsEl.innerText = killCount;
            triggerAnim(killsEl, 'pop-anim');

            const rect = fish.element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            const explosionColor = fish.scoreBonus > 10 ? 'gold' : '#00bfff';
            createExplosion(centerX, centerY, explosionColor);

            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.innerText = `+${points}`;
            popup.style.left = fish.element.style.left; 
            popup.style.top = fish.element.style.top;
            
            if(fish.scoreBonus > 10) {
                popup.style.color = 'gold';
                popup.style.fontSize = '3rem';
                popup.style.textShadow = '0 0 10px gold';
            }

            gameArea.appendChild(popup);
            setTimeout(() => { popup.remove(); }, 1000);

            // --- PHASE 2 LOGIC ---
            if (fish.type === 'puffer') {
                spawnSpecificFish('puffer_thin', fish.x, fish.y);
            }

            if (fish.type === 'sunfish') {
                spawnSpecificFish('sunfish-x', fish.x, fish.y);
            }

            if (fish.type === 'shark') {
                spawnSpecificFish('shark-damaged', fish.x, fish.y);
            }

            if (fish.type === 'hammer') {
                spawnSpecificFish('hammer-damaged', fish.x, fish.y);
            }

            if (fish.type === 'jelly') {
                spawnSpecificFish('jelly-small', fish.x + 120, fish.y + 120);
                spawnSpecificFish('jelly-small', fish.x + 30, fish.y + 100);
            }

            if (fish.type === 'skeleton') {
                spawnSpecificFish('skeleton-2', fish.x, fish.y);
            }
            if (fish.type === 'skeleton-2') {
                spawnSpecificFish('skeleton-3', fish.x, fish.y);
            }
            if (fish.type === 'bone') {
                spawnSpecificFish('bone-2', fish.x, fish.y);
            }

            // Remove old fish
            fish.isDead = true;
            fish.element.remove();  

            const index = activeFishes.indexOf(fish);
            if (index > -1) {
                activeFishes.splice(index, 1);
            }
        }
        
        // Initial setup
        updateHeartsUI();
        requestAnimationFrame(loop);
    </script>
</body>
</html>